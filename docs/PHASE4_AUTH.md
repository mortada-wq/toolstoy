# Phase 4 — Auth Implementation

## Step 1 Complete: AWS Cognito Authentication

Real auth is wired end-to-end. Summary of what was built:

### Cognito Configuration (`amplify/auth/resource.ts`)

- **loginWith**: email
- **Required attributes**: `fullname` (maps to Cognito `name`), `email`
- **Optional**: `custom:store_url` (merchant store URL)

**Important:** If your User Pool was created before these attributes, run:

```bash
ampx sandbox
```

to apply schema changes. If update fails, you may need to delete the sandbox and recreate:

```bash
ampx sandbox --delete
ampx sandbox
```

### New Pages

| Route | Purpose |
|-------|---------|
| `/verify` | Email verification (6-digit code) |
| `/forgot-password` | Send password reset link |
| `/reset-password` | Enter code + new password |

### Components

- **UserContext** (`src/context/UserContext.tsx`): Provides `user`, `isLoading`, `isAuthenticated`, `signOut`, `refreshUser`
- **AuthGuard** (`src/components/AuthGuard.tsx`): Protects `/dashboard` and `/admin`; redirects unauthenticated users to `/signin`

### Flows

1. **Sign Up** → Cognito `signUp` → redirect to `/verify?email=...` → `confirmSignUp` → `/dashboard`
2. **Sign In** → Cognito `signIn` → `/dashboard` (or `from` path)
3. **Forgot Password** → `resetPassword` → `/reset-password` (email in state) → `confirmResetPassword` → `/signin`
4. **Sign Out** → `signOut` → redirect to `/signin`

### Password Policy (from Cognito)

Your pool uses: min 8 chars, uppercase, lowercase, number, symbol. The sign-up form notes this.

### Testing Locally

1. Ensure `amplify_outputs.json` exists (generated by `ampx sandbox`)
2. `npm run dev`
3. Sign up with a new email → verify → sign in
4. Dashboard shows real user name in sidebar
5. Sign out → redirect to sign in
